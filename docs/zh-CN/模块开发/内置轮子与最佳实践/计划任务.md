# 计划任务

[APScheduler](https://github.com/agronholm/apscheduler) (Advanced Python Scheduler) 是一个 Python 第三方库，其具有强大的计划任务实现，Aha 基于其 4.0 版本封装了计划任务服务。

在 Aha 的封装中，维护了两个异步调度器实例：
- 瞬态调度器：调度任务等数据会随 Aha 的关闭而丢失。适用于每次初始化都可能会添加的任务和临时任务等。
- 持久调度器：会写入数据库，Aha 重启后调度任务等数据仍在。使用此调度器时建议尽可能地设定有规律的 ID，既可以防止数据无限累计也可以防止添加重复调度。

当前采用的是 [`AsyncScheduler`](https://apscheduler.readthedocs.io/en/master/api.html#apscheduler.AsyncScheduler)。将于 Python 3.15t 稳定后智能切换至 `Scheduler`。

> 指定 ID 时记得考虑避免不同模块之间<small style="color: gray;">~~默契~~</small>冲突。

## 使用与示例

封装实例为 `services.apscheduler.sched`。使用方法与 [`AsyncScheduler`](https://apscheduler.readthedocs.io/en/master/api.html#apscheduler.AsyncScheduler) 实例大致一致，但也有特性调整。

**在[服务初始化完毕](../../Aha%20生命周期.md)**（基本就是执行 `on_start` 所注册的回调）**之后方可调用。**

```python
from functools import partial
from core.dispatcher import on_start
from services.apscheduler import sched
from utils.apscheduler import TimeTrigger

@on_start
def _():
    # 五秒后打印 "Hello, World!"
    sched.add_schedule(print, TimeTrigger(5), args=("Hello, World!",))

@on_start
async def _():
    sched.add_persist_schedule(print, TimeTrigger(5), id="hello-world", args=("Hello, World!",))
``` 

## 方法

如下所有方法均为异步。

### `sched.add_schedule` / `sched.add_persist_schedule`

添加一个调度在未来执行一次或多次。

**参数**：

| 参数名 | 类型 | 允许为位置参数 | 描述 |
| --- | --- | --- | --- |
| func_or_task_id | [Task](https://apscheduler.readthedocs.io/en/master/api.html#apscheduler.Task) \| str \| Callable | ✅️ | 可调用对象或现有任务定义的 ID。 |
| trigger | [Trigger](https://apscheduler.readthedocs.io/en/master/api.html#triggers) | ✅️ | 决定任务执行时间的触发器。 |
| id | str \| None | ❌️ | 调度的显式标识符（省略时自动生成UUID）。 |
| args | Iterable[Any] \| None | ❌️ | 传递给任务函数的位置参数。 |
| kwargs | Mapping[str, Any] \| None | ❌️ | 传递给任务函数的关键字参数。 |
| paused | bool | ❌️ | 调度是否处于暂停状态。 |
| coalesce | [CoalescePolicy](https://apscheduler.readthedocs.io/en/master/api.html#apscheduler.CoalescePolicy) | ❌️ | 处理因积压产生的多次触发时的合并策略。 |
| job_executor | str | ❌️ | 执行任务的工作执行器名称（覆盖任务设置）。 |
| misfire_grace_time | float \| timedelta \| None | ❌️ | 允许任务实际执行时间晚于计划时间的最大秒数。 |
| metadata | MetadataType | ❌️ | 用于存储JSON兼容自定义信息的键值对。 |
| max_jitter | float \| timedelta \| None | ❌️ | 为每个作业随机添加的最大延迟时间。 |
| job_result_expiration_time | float \| timedelta | ❌️ | 作业结果保留的最小时间（0表示不保存结果）。 |
| conflict_policy | [ConflictPolicy](https://apscheduler.readthedocs.io/en/master/api.html#apscheduler.ConflictPolicy) | ❌️ | 当 ID 已存在时的处理策略。 |

**返回**：新添加调度的 ID (str)。

### `sched.get_tasks` / `sched.persist_sched_get_tasks`

获取当前定义的任务列表。必须提供至少一个筛选条件。

**参数**：

| 参数名 | 类型 | 允许为位置参数 | 描述 |
| --- | --- | --- | --- |
| id | str \| None | ❌️ | 按任务 ID 筛选。 |
| func | Callable \| None | ❌️ | 按可调用对象筛选。 |
| metadata | MetadataType \| None | ❌️ | 按元数据筛选。 |

**返回**：按ID排序的任务列表 (List[[Task](https://apscheduler.readthedocs.io/en/master/api.html#apscheduler.Task)])。

### `sched.get_schedule` / `sched.get_persist_schedule`

通过 ID 获取指定的调度对象。

**参数**：

| 参数名 | 类型 | 允许为位置参数 | 描述 |
| --- | --- | --- | --- |
| id | str | ✅️ | 调度 ID。 |

**返回**：调度对象 ([Schedule](https://apscheduler.readthedocs.io/en/master/api.html#apscheduler.Schedule))。

### `sched.get_schedules` / `sched.get_persist_schedules`

获取调度列表。必须提供至少一个筛选条件。

**参数**：

| 参数名 | 类型 | 允许为位置参数 | 描述 |
| --- | --- | --- | --- |
| id | str \| None | ❌️ | 按调度 ID 筛选。 |
| task_id | str \| None | ❌️ | 按任务 ID 筛选。 |
| metadata | MetadataType \| None | ❌️ | 按元数据筛选。 |

**返回**：调度列表，顺序未指定 (List[[Schedule](https://apscheduler.readthedocs.io/en/master/api.html#apscheduler.Schedule)])。

### `sched.remove_schedule` / `sched.remove_persist_schedule`

移除指定的调度。

**参数**：

| 参数名 | 类型 | 允许为位置参数 | 描述 |
| --- | --- | --- | --- |
| id | str | ✅️ | 调度 ID。 |

### `sched.rm_schedules_by_meta` / `sched.rm_persist_schedules_by_meta`

移除所有匹配给定元数据的调度，并返回移除的数量。

**参数**：

| 参数名 | 类型 | 允许为位置参数 | 描述 |
| --- | --- | --- | --- |
| metadata | MetadataType | ✅️ | 用于匹配的元数据键值对。 |

**返回**：被移除的调度数量 (int)。

### `sched.pause_schedule` / `sched.pause_persist_schedule`

暂停指定的调度。

**参数**：

| 参数名 | 类型 | 允许为位置参数 | 描述 |
| --- | --- | --- | --- |
| id | str | ✅️ | 调度 ID。 |

### `sched.unpause_schedule` / `sched.unpause_persist_schedule`

恢复指定的调度。

**参数**：

| 参数名 | 类型 | 允许为位置参数 | 描述 |
| --- | --- | --- | --- |
| id | str | ✅️ | 调度 ID。 |
| resume_from | datetime \| Literal["now"] \| None | ❌️ | 恢复的时间点，`now` 表示当前 UTC 时间，`None` 表示从上次中断处恢复（可能触发遗漏执行）。 |

### `sched.add_job` / `sched.add_persist_job`

添加一个作业（一次性执行的任务）。

**参数**：

| 参数名 | 类型 | 允许为位置参数 | 描述 |
| --- | --- | --- | --- |
| func_or_task_id | [Task](https://apscheduler.readthedocs.io/en/master/api.html#apscheduler.Task) \| str \| Callable | ✅️ | 可调用对象或现有任务定义的 ID。 |
| args | Iterable[Any] \| None | ❌️ | 传递给任务函数的位置参数。 |
| kwargs | Mapping[str, Any] \| None | ❌️ | 传递给任务函数的关键字参数。 |
| job_executor | str | ❌️ | 执行任务的工作执行器名称（覆盖任务设置）。 |
| metadata | MetadataType | ❌️ | 用于存储 JSON 兼容自定义信息的键值对。 |
| result_expiration_time | timedelta \| float | ❌️ | 作业结果保留的最小时间（0 表示不保存结果）。 |

**返回**：新创建作业的 ID (UUID)。

### `sched.get_jobs` / `sched.get_persist_jobs`

获取作业列表。必须提供至少一个筛选条件。

**参数**：

| 参数名 | 类型 | 允许为位置参数 | 描述 |
| --- | --- | --- | --- |
| id | UUID \| None | ❌️ | 按作业 ID 筛选。 |
| task_id | str \| None | ❌️ | 按任务 ID 筛选。 |
| schedule_id | str \| None | ❌️ | 按调度 ID 筛选。 |
| metadata | MetadataType \| None | ❌️ | 按元数据筛选。 |

**返回**：作业列表 (List[[Job](https://apscheduler.readthedocs.io/en/master/api.html#apscheduler.Job)])。

### `sched.get_job_result` / `sched.get_persist_job_result`

获取作业的执行结果。

**参数**：

| 参数名 | 类型 | 允许为位置参数 | 描述 |
| --- | --- | --- | --- |
| job_id | UUID | ✅️ | 作业的 ID。 |
| wait | bool | ❌️ | 是否等待作业结束（True）或立即返回（False，若结果未就绪则引发异常）。 |

**返回**：作业结果 ([JobResult](https://apscheduler.readthedocs.io/en/master/api.html#apscheduler.JobResult))。若作业未保存结果则返回 None。

### `sched.run_job` / `sched.run_persist_job`

添加一个作业并立即等待其执行结果。

**参数**：

| 参数名 | 类型 | 允许为位置参数 | 描述 |
| --- | --- | --- | --- |
| func_or_task_id | str \| Callable | ✅️ | 可调用对象或现有任务定义的 ID。 |
| args | Iterable[Any] \| None | ❌️ | 传递给任务函数的位置参数。 |
| kwargs | Mapping[str, Any] \| None | ❌️ | 传递给任务函数的关键字参数。 |
| job_executor | str | ❌️ | 执行任务的工作执行器名称（覆盖任务设置）。 |
| metadata | MetadataType | ❌️ | 用于存储 JSON 兼容自定义信息的键值对。 |

**返回**：任务函数的返回值。

### `sched.configure_task`

添加或更新一个瞬态任务定义。

**参数**：

| 参数名 | 类型 | 允许为位置参数 | 描述 |
| --- | --- | --- | --- |
| func_or_task_id | [Task](https://apscheduler.readthedocs.io/en/master/api.html#apscheduler.Task) \| str \| Callable | ✅️ | 任务 ID 或可调用对象（若为可调用对象，则创建新任务）。 |
| func | Callable | ❌️ | 与任务关联的可调用对象（用于更新）。 |
| job_executor | str | ❌️ | 执行任务的工作执行器名称。 |
| misfire_grace_time | float \| timedelta \| None | ❌️ | 允许任务实际执行时间晚于计划时间的最大秒数。 |
| max_running_jobs | int \| None | ❌️ | 允许并发运行的最大任务实例数。 |
| metadata | MetadataType | ❌️ | 用于存储JSON兼容自定义信息的键值对。 |

**返回**：创建或更新后的任务定义 ([Task](https://apscheduler.readthedocs.io/en/master/api.html#apscheduler.Task))。

### `sched.persist_sched_configure_task`

添加或更新一个持久化任务定义。任务ID从函数的完全限定名派生。

**参数**：

| 参数名 | 类型 | 允许为位置参数 | 描述 |
| --- | --- | --- | --- |
| func | Callable | ✅️ | 与任务关联的可调用对象。 |
| job_executor | str | ❌️ | 执行任务的工作执行器名称。 |
| misfire_grace_time | float \| timedelta \| None | ❌️ | 允许任务实际执行时间晚于计划时间的最大秒数。 |
| max_running_jobs | int \| None | ❌️ | 允许并发运行的最大任务实例数。 |
| metadata | MetadataType | ❌️ | 用于存储 JSON 兼容自定义信息的键值对。 |

**返回**：创建或更新后的任务定义 ([Task](https://apscheduler.readthedocs.io/en/master/api.html#apscheduler.Task))。
