# 缓存

[cachetools](https://github.com/tkem/cachetools) 是一个 Python 第三方库，其提供了多种缓存策略和易用的装饰器。

Aha 封装了其所有的缓存器，额外提供了基于内存占用和计划任务的缓存策略，且将所有缓存器弱引用至 `core.cache.cachers` 集合便于管理。

## `@async_cached()`

`core.cache.async_cached` 是一个逻辑类似 `functools.lru_cache` 的函数，返回仅适用于异步的装饰器。该装饰器逻辑耦合、功能不全，但是能用。

建议使用 [cachetools-async](https://github.com/imnotjames/cachetools-async) 库的 `cached` 或 `cachedmethod` 函数。

具有如下参数：

| 参数名 | 可选 | 说明 |
| --- | --- | --- |
| `cache` | ❌️ | 缓存器实例。 |
| `key` | ✅️ | 缓存键生成器，默认为以被装饰函数传入的参数调用 `cachetools.hashkey`。 |
| `ignore` | ✅️ | 接受 Callable：接受被装饰函数返回值、位置与关键字参数，返回值的 bool 为 True 时本次调用结果不写入缓存。 |

被装饰的函数增加了两个关键字参数：

| 参数名 | 说明 |
| --- | --- |
| `no_cache` | bool 为 `True` 时本次调用不查询缓存。 |
| `cache_key` | 指定本次调用的缓存键生成器。 |

## 示例

```python
from cachetools_async import cached
from core.cache import MemLRUCache
from core.config import cfg
from utils.unit import parse_size
import python_weather

CACHE_SIZE = parse_size(cfg.register("cache_size", "1MiB"))

@cached(cache=MemLRUCache(CACHE_SIZE))
async def get_weather(place):
    async with python_weather.Client(unit=python_weather.METRIC) as client:
        return await client.get(place)
```
