# 文件缓存

> 为避免到处拉屎，Aha 提供了文件缓存服务。

缓存路径由配置文件 `cache.file_cache.dir` 指定，`cache.file_cache.cron` 定时清理过期文件。

支持提供文件内容直接写入或仅注册一个文件路径。后者时若路径已存在文件不会自动删除。

相同路径的文件每次注册重设过期时间。

文件内容支持 `BinaryIO | bytes | str | AsyncIterable[bytes | str] | Iterable[bytes | str]`，智能流式读取与写入。

## 使用与示例

采用工作单元模式。通过 `services.file_cache.cache_file_sessionmaker` 获取会话，一个会话对应一个文件路径，相同路径存在锁。通过 `.register` 方法注册过期时间与写入文件内容。

**在[服务初始化完毕](../../Aha%20生命周期.md)**（基本就是执行 `on_start` 所注册的回调）**之后方可调用。**

```python
from anyio import Path
from services.file_cache import cache_file_sessionmaker

async with cache_file_sessionmaker() as session:  # 文件名采用内容哈希（xxh3 128）或随机
    path: Path = await session.register(300, b'hello world')  # 过期时间 300 秒，但自动清理时机跟随 cron

from aiofiles import open as aioopen

async with cache_file_sessionmaker("test_file.txt") as session:  # 指定文件名
    path: Path = await session.register(300)  # 仅注册路径
    async with aioopen(path, 'w') as f:  # 自行写入文件内容
        await f.write('hello world')
```
