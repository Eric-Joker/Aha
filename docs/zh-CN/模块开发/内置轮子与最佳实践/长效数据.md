# 长效数据

[Sqlalchemy](https://www.sqlalchemy.org/) 是 Python 中最流行的 ORM（对象关系映射） 框架之一，Aha 本身采用了基于其的数据库长效存储方案。推荐模块使用相同数据库进行数据存储。

## [通过 Sqlalchemy 操作数据库](https://www.google.com/search?q=Sqlalchemy)

**使用声明式映射时需继承自 `core.database.dbBase`；使用命令式映射时 `metadata` 参数需指定为 `core.database.metadata`。**

一般情况下，实际写入数据库的表名会被重定向为 `f"{__tablename__}__{模块名}"`。

开发时若使用重载特性建议将 Table 定义在模块目录的 `database.py` 文件或 `database` 目录下，这两个地方不会被重载。

Aha 声明支持 SQLite 与 PostgreSQL，尽可能不要使用方言。

### 数据结构更新

Aha 实现了基于 [Alembic](https://github.com/sqlalchemy/alembic) 的自动数据库迁移特性。若涉及其无法正确迁移数据的更改，请通过 `@on_start` 注册手动迁移回调。

### 示例

```python
# database.py
from sqlalchemy import BigInteger, Text
from sqlalchemy.orm import Mapped, mapped_column
from core.database import dbBase

class Test(dbBase):
    __tablename__ = "test"

    user: Mapped[int] = mapped_column(BigInteger, primary_key=True)
    data: Mapped[str] = mapped_column(Text)

# __init__.py
from collections.abc import Sequence
from core.database import db_sessionmaker
from core.dispatcher import on_message
from models.api import Message
from models.msg import Text
from utils.sqlalchemy import upsert
from .database import Test

@on_message(["set", Text])
async def _(event: Message, args: Sequence[str]):
    async with db_sessionmaker() as session:
        await session.execute(upsert(Test, user=await event.user_aha_id(), data=args[0]))
        await session.commit()

@on_message("get")
async def _(event: Message):
    async with db_sessionmaker() as session:
        await event.reply(session.get(Test, await event.user_aha_id()))
```

## SimpleStore（不推荐！）

使用 Sqlalchemy 可能有些复杂，Aha 封装了一个操作逻辑像字典的方案。

支持 `__getitem__`、`__setitem__`、`__delitem__`、`__len__`、`__iter__`、`__contains__`、`get`、`keys`、`values`、`pop`、`popitem`、`clear`、`update`、`setdefault` 方法。

### 注意事项

1. 模块需要**在加载阶段**初始化一个 `services.data_store.SimpleStore` 实例，之后的一切操作均基于此实例。
2. 每个模块仅可初始化一个 `SimpleStore` 实例。
3. 内存中将始终存在全部数据，且非即时写入；请勿通过该方案存储大量数据以防止内存溢出，且非正常退出 Aha 进程可能导致数据丢失。
4. 键只能是字符串，值只能是可被 pickle 的类型。
5. `SimpleStore` 并非 `dict` 的子类。

### 示例

```python
from core.dispatcher import on_message
from models.api import Message
from services.data_store import SimpleStore

data_store = SimpleStore()

@on_message("test")
async def _(event: Message):
    data_store["test"] = "hello"

@on_message("get")
async def _(event: Message):
    await event.send(data_store["test"])
```
