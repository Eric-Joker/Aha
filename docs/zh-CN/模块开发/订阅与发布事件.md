# 事件

Aha 的设计贯彻着事件驱动原则。模块可以通过为部分事件类别注册回调函数实现事件消费。

## 事件类别

对于模块，共有 5 种公开事件类别和 3 种非公开事件类别。

| 类别 | 对模块公开 | [对象](../数据结构/事件对象.md) | “注册回调装饰器” | 说明 |
| --- | --- | --- | --- | --- |
| CHAT | ✅️ | [models.api.Message](../数据结构/事件对象.md#message) | core.dispatcher.on_message | 用户发送消息。 |
| NOTICE | ✅️ | [models.api.Notice](../数据结构/事件对象.md#notice) | core.dispatcher.on_notice | 用户发送通知。 |
| REQUEST | ✅️ | [models.api.Request](../数据结构/事件对象.md#request) | core.dispatcher.on_request | 用户发送请求。 |
| META | ✅️ | [models.api.MetaEvent](../数据结构/事件对象.md#metaevent) | core.dispatcher.on_meta | 协议服务元事件。 |
| EXTERNAL | ✅️ | Any | core.dispatcher.on_external | 非标准事件结构。用于 Web 请求，也可以作为模块间的触发器。 |
| SENT | ❌ | [models.api.MessageSent](../数据结构/事件对象.md#messagesent) | | 协议服务正在登陆账号所有发送的消息。 |
| RESPONSE | ❌ | Any | | 协议适配器 API 返回值。 |
| SERVICE_REQUEST | ❌ | Any | | 协议适配器向主进程的服务请求。 |

## 注册回调函数

模块通过声明一个函数，并通过上述“注册回调装饰器”装饰该函数以订阅事件。

“注册回调装饰器”实质是一个返回装饰器的函数，其具有一些参数。虽然每个函数的参数不尽相同，但均有个用于筛选事件的参数。对于标准事件，Aha 提供了[基于 DSL（领域特定语言）的筛选方案](./事件匹配表达式.md)；当然，简单地通过正则的筛选并无不可。

> 仅可装饰异步函数。不得装饰非 Python 实现的函数，因为无法获取参数信息。

基本使用方式请参考[示例](./示例.md)与代码中函数的`__doc__`。

### 一次性回调

通过声明“注册回调装饰器”的 `exp`（过期时间）参数实现，当成功触发一次后，回调将被自动注销。

若传入的值小于10^9，将会被修正为与当前秒级时间戳累加。

```python
from core.dispatcher import on_message
from models.api import Message

@on_message("注册一次性回调")
async def _(event: Message[Text]):
    on_message("114", exp=5*60, callback=callback)
    await event.reply("ok")

async def callback(event: Message):
    await event.reply("514")
```

### 预处理匹配的消息内容

有些时候我们的业务逻辑需求不那么循规蹈矩。比如我们希望处理任意消息中的图片，但正则等其他方式并不那么优雅且灵活。

 `on_message` 函数提供了 `pre_hook` 参数，用于在匹配前对消息内容进行预处理，且处理后的内容会被替换到回调接受的 `event` 参数的 `message`属性。

```python
from core.dispatcher import on_message
from models.api import Message
from models.msg import Image, MsgSeq

@on_message(pre_hook=lambda msg: MsgSeq(x for x in msg if isinstance(x, Image)))
async def _(event: Message[Image]):
    await event.reply(str(all(isinstance(x, Image) for x in event.message)))
```

## 发布事件

一般用于跨模块功能的触发。暂不存在支持获取返回值的方法，建议直接 import。

建议确保 `on_start` 注册的回调函数被调用后再发布事件。

```python
from functools import partital
from core.dispatcher import on_start, process_external

on_start(partital(process_external, "key", "data"))
```
