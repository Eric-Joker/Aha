# 消息内容结构

Aha 使用**消息段（MsgSeg）** 作为消息的基本组成单元，多个消息段按顺序组合成**消息链（MessageChain）**。

## MessageChain

是继承自 `list` 的容器，专门用于存放消息段实例。

### 创建消息序列

```python
from models.msg import MsgSeq

msg = MsgSeq("Hello", Image(file="path/to/image.jpg")) # 从多个字符串或消息段创建

segments = [Text("Hello"), At(user_id="123456")]
msg = MsgSeq(segments) # 从可迭代对象创建
```

- 所有非 `MsgSeg` 的元素会被自动转换为 `Text` 段。

### 操作消息链

`MessageChain` 支持所有列表方法，且会自动将添加的字符串转为 `Text` 段。此外提供了一些实用方法：

- `filter(cls)`：返回只包含指定类型消息段的新链。
- `is_user_at(user_id, include_all=False)`：检查是否 @ 了指定用户。
- `__str__`：序列化为包含 Aha 码的字符串。

## MsgSeg

是 [Pydantic](https://github.com/pydantic/pydantic) Model。每个消息段代表一种特定类型的消息内容，如纯文本、图片、@等。所有消息段均继承自 `MsgSeg`，并拥有以下通用特性：

- 实例具有 `__str__`，可被转换成 [Aha 码](../模块开发/Aha%20码.md)。

- 消息段元类实现了 `__str__` 方法，返回匹配对应 Aha 码的正则表达式字符串，可通过 `Match[属性名]` 获取[**转义**](../模块开发/Aha%20码.md#转义)**后**的属性值字符串。类方法 `prefixed_re_group(prefix)` 生成的正则会为命名捕获组添加前缀。
  ```python
  pattern = re.compile(str(At))  # \[Aha:at(?:,user_id=(?P<user_id>[\s\S]*?))?(?:,name=(?P<name>[\s\S]*?))?\]
  match = pattern.match("[Aha:at,user_id=123456,name=小明]")
  match["user_id"]  # "123456"

  re.compile(At.prefixed_re_group("at_"))  # \[Aha:at(?:,user_id=(?P<at_user_id>[\s\S]*?))?(?:,name=(?P<at_name>[\s\S]*?))?\]
  ```

### Text
纯文本。

| 属性 | 类型 | 说明 |
| --- | --- | --- |
| text | str | 文本内容。 |

**示例**：`Text(text="你好")`

### At
@某人或全体成员。

| 属性 | 类型 | 说明 |
| --- | --- | --- |
| user_id | str \| None | 被@用户的平台 ID，`"all"` 表示全体。 |
| name | str | 用户名，发送时无需设置。 |

**`At.all()`**：返回 @全体 的段。

**示例**：`At(user_id="123456")`

### Reply
引用消息。要放在消息链的开头。

| 属性 | 类型 | 说明 |
| --- | --- | --- |
| id | str | 被引用的消息 ID。 |

### Downloadable
可下载消息段基类。

| 属性 | 类型 | 说明 |
| --- | --- | --- |
| file | str \| Path \| bytes | 文件源，可能为本地路径或 URL。在少数情况下可能为 `bytes`，但此时不可参与 [API 调用](../模块开发/向协议服务请求/说明.md)。 |
| name | str | 文件名。 |
| file_id | Any | 适配器返回的文件唯一 ID。 |
| thumb | str \| None | 缩略图URL或路径。 |
| file_type | str \| None | 文件类型（只读）。 |
| file_size | int \| None | 文件大小（只读）。 |

**下载与流式**：

```python

path = await image.download()  # 下载至文件缓存服务
path = await image.download(dir_="./images", name="custom.jpg")  # 下载到指定路径，覆盖已有文件。

async for chunk in video.stream(): # 获取文件流（逐块读取）
    pass
```

> 下载至文件缓存服务时，最小存活时间由[配置文件](../统一配置系统.md)中的 `cache.file_msg_ttl` 指定。

### Image
图片。继承自 [Downloadable](#downloadable)。

| 属性 | 类型 | 说明 |
| --- | --- | --- |
| summary | str \| None | 描述。 |
| sub_type | Any | 子类型。 |

从PIL图像创建：
```python
from PIL import Image as PILImage
from models.msg import Image

img = PILImage.open("cat.jpg")
seg = await Image.from_pil(img, format="PNG", name="cat.png")  # 实质上是保存文件至文件缓存服务。后两个参数可省略。
```

### Sticker
动画表情。继承自 [Downloadable](#downloadable)。属性同 [`Image`](#image)。

### File
普通文件。继承自 [Downloadable](#downloadable)。

| 属性 | 类型 | 说明 |
| --- | --- | --- |
| group_id | str \| None | 群文件所属群聊平台 ID。 |

### Record
语音。继承自 [Downloadable](#downloadable)。

下载/流式时可通过 `record_format` 参数指定文件格式，值为 [`AudioFormat`](../数据结构/API%20相关.md#modelsapiaudioformat) 枚举。

### Video
视频。继承自 [Downloadable](#downloadable)，无额外属性。

### Share
链接分享。

| 属性 | 类型 | 说明 |
| --- | --- | --- |
| url | str | 分享链接。 |
| title | str \| None | 标题。 |
| content | str \| None | 简介。 |
| image | str \| Path \| None | 封面图。 |

### Contact
推荐好友或群。

| 属性 | 类型 | 说明 |
| --- | --- | --- |
| type | Literal["friend", "group"] | 联系人类型。 |
| id | str \| None | 用户平台 ID 或群聊平台 ID。 |

### Location
地理位置。

| 属性 | 类型 | 说明 |
| --- | --- | --- |
| lat | float | 纬度。 |
| lon | float | 经度。 |
| title | str \| None | 地点名称。 |
| content | str \| None | 详细地址。 |

### Music
音乐分享。

| 属性 | 类型 | 说明 |
| --- | --- | --- |
| url | str | 跳转链接。 |
| audio | str \| None | 音频文件 URL。 |
| title | str \| None | 标题。 |
| image | str \| Path | 封面。 |
| content | str \| None | 更多信息，一般是歌手名。 |

### Json
Json 卡片消息。

| 属性 | 类型 | 说明 |
| --- | --- | --- |
| data | dict \| list | 解析后的 json。 |

### Xml
Xml 卡片消息。

| 属性 | 类型 | 说明 |
| --- | --- | --- |
| data | lxml.etree._Element | 解析后的 XML。 |

### Markdown
Markdown 卡片消息。

| 属性 | 类型 | 说明 |
| --- | --- | --- |
| content | str | Markdown 原文。 |

### 合并转发

#### Forward
合并转发（消息记录）。

有两种表示方式：
- **仅含 ID**：`Forward(id="12345")`，之后若有需要可以通过 [API](../模块开发/向协议服务请求/Message%20有关%20API.md#get_forward_msg) 拉取内容。
- **含完整消息内容**：`Forward(content=[Node(...), ...])`

| 属性 | 类型 | 说明 |
| --- | --- | --- |
| id | str \| None | 协议服务提供的转发消息ID。 |
| content | MessageChain[Node] \| None | 消息内容。 |
| message_type | "group" \| "private" | 自动推断，也可手动指定。 |

<details>
<summary>便捷方法</summary>

**`async get_content()`**：

根据 `id` 属性拉取消息内容并赋值给 `content`。可通过 [`select_bot`](../模块开发/向协议服务请求/说明.md#指定-bot-实例) 指定 `bot_id` 参数。

**`filter(cls)`**：

返回所有节点中指定类型消息段的扁平链。

**`async append(Node)`**：

添加一个节点。可指定 `user_id` 和 `nickname` 参数时，未指定时自动从 `bot_id` 参数[获取](../模块开发/向协议服务请求/Account%20有关%20API.md#get_login_info)，未指定 `bot_id` 时采用与当前事件上下文相同的。

**`async extend(Iterable[Node])`**：

批量添加节点，其余参数同上。

**`classmethod async from_content(MessageChain)`**：

从内容列表直接构造，其余参数同上。

</details>

> 一个消息链中 `Forward` 不得与其他消息段混用。

#### Node
转发节点，用于为合并转发的每条消息绑定发送者。只可出现在 `Forward.content` 中。

| 属性 | 类型 | 说明 |
| --- | --- | --- |
| user_id | str \| None | 发送者平台 ID。 |
| nickname | str | 发送者昵称。 |
| content | MessageChain | 消息内容（不可包含 `Node` 实例）。 |

#### 示例

```python
from models.msg import Forward, Node, Image

# 通过 from_content 快速创建
forward = await Forward.from_content(
    content=["第一条消息", Image(file="img.jpg"), "第二条消息"],
    user_id="111",          # 如果不指定，则自动获取bot自身信息
    nickname="MyBot"
)

# 或手动构造节点
node1 = Node(user_id="111", nickname="Alice", content="你好")
node2 = Node(user_id="222", nickname="Bob", content=Image(file="bob.png"))
forward = Forward(content=[node1, node2])

# 发送到群聊
await API.send_group_msg(group_id=123456, message=forward)
```