# 本地化

Aha 具有国际化与本地化支持，允许回调根据用户使用的语言动态切换回复内容。本文档将循序渐进地介绍如何为 Aha 模块应用本地化功能。

## 1. 准备翻译文件

在模块目录下创建 `locales/` 文件夹，然后放入以语言代码命名的 YAML 文件。例如：

```
your_module/
├── __init__.py
├── locales/
│   ├── zh_CN.yaml
│   ├── en.yaml
│   └── ja.yaml
└── ...
```

每个 YAML 文件的内容是一个键值对字典，例如 ：

```yaml
# zh_CN.yaml：
hello: "你好"
return: "世界！"
hello_pattern: "你好(?:,|，)?"

# en_US.yaml：
hello: "Hello"
return: "World!"
hello_pattern: "Hello(?:,|，|\s)?"
```

> 语言代码可以为任意字符串。

## 2. 使用本地化

### 2.1 获取本地化字符串：`_(key)`

```python
from core.i18n import _

print(_('hello'))  # 此时输出的是配置文件中 `aha.lang` 所指定语言的翻译，若没有翻译会尝试回退直至键名本身。
```

`_()` 返回的是一个 `LocalizedString` 对象，它继承自 `str`。

### 2.2 通过[表达式](事件匹配表达式.md)匹配本地化键名动态获取本地化

对 `PM.message` 采用正则相关或相等/不等比较运算符时，若另一操作数为本地化字符串，则会匹配所有语言，并创建匹配成功的语言的翻译器。会将翻译器传递给回调的 `localizer` 关键字参数。

如：
```python
from core.i18n import _
from core.dispatcher import on_message
from core.expr import Pmsg

@on_message(Pmsg == _('hello'))
@on_message(_('hello_pattern'))  # 正则同样可以本地化。
async def __(event, localizer):
    await event.reply(localizer('return'))  # 回复用户对应语言的文案
```

如果用户使用中文发送“你好”则会回复“世界！”，若用英文发送 “Hello” 则会回复 “World!”。

`on_external` 所注册回调接受的 `localizer` 的语言由上游逻辑指定。

> 所有通过[注册回调装饰器](./订阅与发布事件.md)装饰的函数均可声明 `localizer` 关键字参数。
> 若未触发上述情形，其会优先传递协议适配器在[配置文件](./统一配置系统.md)中 `lang` 键指定的语言的翻译器。

## 进阶说明

### 语言回退链

当需要获取某语言的翻译时，会按照以下顺序查找：

1. 指定的语言代码（如 `zh_CN`）
2. 该语言代码的基础语言（如 `zh`）
3. 部分基础语言的方言（如 `zh_TW`, `zh_HK` 等，根据 `core.i18n.LANGUAGE_FALLBACKS` 定义）
4. [配置文件](./统一配置系统.md)中 `aha.lang` 指定的默认语言及其基础语言与方言
5. 最后回退到 `en` 和 `zh` 作为保底

因此，若没有为 `zh_CN` 提供翻译，但只要提供了 `zh` 的翻译，也会被使用。

### 手动获取翻译器：`create_translator`

```python
from core.i18n import create_translator

translator = create_translator(module='modules.your_module', lang_code='zh_CN')
text = translator('some.key')
```

参数 `module` 指定从哪个模块的本地化文件中查找，为 None 时采用框架根目录下的 `locales` 目录中的本地化文件。
